<: :>//
#!/usr/bin/make -f
# 
# debian/rules file for <:=$srcpackage:>
# $Id$

PACKAGES=<:=$binpackages:>
METAPACKAGES=<:=$metapackages:>

SHELL=/bin/bash

build: build-arch build-indep
build-arch: build-stamp
build-indep: build-stamp

build-stamp:
<: if ($srcpackage eq "texlive-lang") { _:>//
	# SHOULD BE DELETED FOR FINAL 2012 SINCE uptex WILL BE INTEGRATED!
	tar -xf debian/uptex.tar.xz
	tar -xf debian/uptex.doc.tar.xz
	tar -xf debian/uptex.source.tar.xz
<: } :>//
	touch build-stamp

clean: 
	for i in $(PACKAGES) $(METAPACKAGES) ; do \
	  rm -f debian/$$i.{README.Debian,links,links.generated} ; \
	  rm -f debian/$$i.{postinst,postrm,preinst,prerm} ; \
	  rm -f debian/$$i.{maps,hyphens,formats} ; \
	done
<: if ($srcpackage eq "texlive-base") { _:>//
	rm -f debian/texlive-base.cnf
<: } :>//
	# texlive contains some .orig files we need to keep otherwise
	# the copy will fail due to the files occurring in the tlpdb
	dh_clean -X.orig -X.bak
<: if ($srcpackage eq "texlive-lang") { _:>//
	# SHOULD BE DELETED FOR FINAL 2012 SINCE uptex WILL BE INTEGRATED!
	rm -rf texmf-dist/doc/uplatex
	rm -rf texmf-dist/doc/uptex
	rm -rf texmf-dist/source/fonts/uptex
	rm -rf texmf-dist/source/uplatex
	rm -rf texmf-dist/fonts/map/dvipdfmx/uptex
	rm -rf texmf-dist/fonts/tfm/uptex
	rm -rf texmf-dist/fonts/vf/uptex
	rm -rf texmf-dist/scripts/uptex
	rm -rf texmf-dist/tex/uplatex
	rm -rf texmf-dist/tex/uptex
	rm -rf tlpkg/tlpobj/uptex.*
	# end of TEMP
<: } :>//
	rm -f configure-stamp
	rm -f build-stamp
	rm -f install-stamp

install: install-stamp

install-stamp: build-stamp
	# make sure we have texmf/web2c otherwise the media detection
	# might break (like in texlive-lang)
	mkdir -p texmf/web2c
	perl debian/tpm2deb-bin.pl --nosource $(PACKAGES) $(METAPACKAGES)
	for i in $(PACKAGES) $(METAPACKAGES) ; do \
	  if [ -d debian/$$i.root ] ; then bash debian/merge-dist-tree debian/$$i.root debian/$$i ; fi ; \
	  bash debian/generate-license-file $$i ; \
	  install -D --mode=644 debian/$$i.override debian/$$i/usr/share/lintian/overrides/$$i ; \
	  install -D --mode=755 debian/bug.script debian/$$i/usr/share/bug/$$i/script ; \
	  install -D --mode=644 debian/bug.control debian/$$i/usr/share/bug/$$i/control ; \
	  bash debian/create-doc-links $$i texlive-doc > debian/$$i.links ; \
	  if [ -r debian/$$i.links.dist ] ; then cat debian/$$i.links.dist >> debian/$$i.links ; fi ; \
	  if [ -r debian/$$i.README ] ; then cat debian/$$i.README > debian/$$i.README.Debian ; fi ; \
	  cat debian/README.Debian >> debian/$$i.README.Debian ; \
	done
	touch install-stamp

binary-arch:

binary-indep: build install
	dh_testdir
	dh_testroot
	dh_install
	dh_installdirs
	dh_installmenu
	dh_installdocs -A debian/README.source
<: if ($srcpackage eq "texlive-base") { _:>//
	dh_installdocs -p texlive-common README readme-txt.dir readme-html.dir debian/CHANGES.packaging
	dh_installtex -Ntexlive-base -A --priority=10	\
		$(patsubst %,-N%,$(METAPACKAGES))	\
		--flavor=lsr:full,tree:texlive
	dh_installtex -ptexlive-base --priority=10	\
		--flavor=format:build_all,lsr:full,tree:texlive
	# /usr/bin/mf has been created by dh_installtex as symlink to mf-nowin
	# but is also shipped by texlive-base-bin, remove it.
	rm debian/texlive-base/usr/bin/mf
	# remove updmap(-sys), they are shipped in texlive-binaries
	rm debian/texlive-base/usr/bin/updmap
	rm debian/texlive-base/usr/bin/updmap-sys
	# furthermore we want to have etex and pdfetex as links in 
	# texlive-base-bin and not in texlive-base, remove them here
	# and add them via dh_link in texlive-base-binaries
	rm debian/texlive-base/usr/bin/etex 
	rm debian/texlive-base/usr/bin/pdfetex
	# for the libpaper hook, install templates and
	# translations. No need to modify postrm. I hope it accepts
	# the missing config script
	dh_installdebconf -n
	cp debian/texlive-base.libpaper debian/texlive-base/etc/libpaper.d/texlive-base
	chmod a+x debian/texlive-base/etc/libpaper.d/texlive-base
	#cp debian/md5sums/* debian/texlive-base/usr/share/texlive-base/
<: } else { _:>//
	dh_installtex -A --priority=10 --flavor=lsr:full,tree:texlive
<: } :>//
	dh_installchangelogs
	bash debian/convert-info-files-to-unix.sh
	bash debian/fix-manpages.sh
	dh_installinfo
<: if ($srcpackage eq "texlive-base") { _:>//
	# remove info files that are present in texlive-binaries
	rm debian/texlive-base/usr/share/info/dvips.info*
	rm debian/texlive-base/usr/share/info/web2c.info*
	rm debian/texlive-base/usr/share/info/kpathsea.info*
	rmdir --ignore-fail-on-non-empty debian/texlive-base/usr/share/info
<: } :>//
	dh_installmime
	dh_link
	dh_compress -X.pdf
	dh_fixperms
	# we also have to fix the permissions of the link targets from /usr/bin
	bash debian/fix-bin-symlink-targets-permissions.sh
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install

# eof
